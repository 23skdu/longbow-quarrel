# Task: Debugging Metal Kernel Crash and Repetitive Output

- [x] **Fix SIGSEGV Crash**
  - [x] Restore accidentally deleted Metal kernels (`linear_f16`, `embedding_f16`, etc.)
  - [x] Add detailed error logging to `loadPipeline` in `metal_backend.m`
- [x] **Stabilize Numerical Calculations**
  - [x] Correct `RoPE` to use adjacent rotation pairs (matching Llama architecture)
  - [x] Fix potential `NaN` in `Softmax` by stabilizing max calculation
  - [x] Implement `safe_half` clamping utility in `kernels.metal`
  - [x] Apply `safe_half` to all critical kernels (`Linear`, `Attention`, `Residual Add`)
- [x] **Verify Baseline Integrity**
  - [x] Add `ScanNaNs` and `ScanMax` to weight loading loop
  - [x] Verify all model weights are "OCD Clean" on startup
  - [x] Zero-initialize `KV Cache` buffers to prevent garbage data reads
- [/] **Investigate Activation Explosion (Layer 26/27)**
  - [x] Trace `NaN` and `Max` values across all layers and tokens
  - [x] Identify first `NaN` occurrence (Token 1, Layer 26 output)
  - [ ] Analyze Layer 26/27 specifically (since they use FP16 weights vs Q4K)
  - [ ] Perform granular logit comparison with `llama.cpp` for the first divergent layer
- [ ] **Final Verification**
  - [ ] Resolve "anzaanza" repetitive output
  - [ ] Confirm coherent text generation for "What is the chemical symbol for gold?"
