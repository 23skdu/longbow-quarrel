import json
import numpy as np
import sys
from verify_dequant import dequantize_q4_k

# Data from Go output
go_bytes = [44,1,227,9,99,245,164,173,92,223,91,96,47,255,85,217,64,39,245,124,32,29,205,58,105,91,118,117,160,99,88,70,24,149,106,75,71,105,8,92,50,143,86,42,101,166,71,59,169,97,186,175,125,73,10,103,141,84,19,175,178,168,32,23,175,75,142,136,152,148,123,157,200,249,219,141,109,196,87,104,187,64,134,158,131,107,131,176,182,187,80,136,222,137,167,119,198,148,8,185,181,170,177,166,168,243,132,99,200,215,202,219,196,1,150,181,111,118,147,42,85,133,89,82,176,197,151,184,199,141,37,51,50,118,38,151,2,92,223,119,132,160,154,247]
go_floats = [-0.005030,-0.000649,-0.001901,0.002480,-0.005030,0.003106,0.003106,0.001228,0.000602,0.001854,-0.001275,-0.001901,-0.005030,-0.003153,-0.000023,-0.001275,-0.002527,-0.003778,0.004358,-0.000649,-0.003778,-0.004404,0.002480,-0.003153,-0.001275,-0.001901,-0.000649,-0.000649,0.001228,-0.001275,-0.001901,-0.002527,0.002013,-0.000831,0.003908,0.004856,0.001065,0.002960,0.002013,0.005803,-0.003674,0.008647,0.000117,0.003908,-0.000831,0.000117,0.001065,0.004856,-0.004621,0.002960,0.000117,-0.001778,-0.001778,0.000117,-0.005569,-0.000831,-0.002726,0.002013,-0.000831,-0.003674,0.000117,0.003908,-0.001778,-0.002726,0.000943,-0.004207,0.001587,0.004805,0.003518,0.000943,0.001587,-0.000344,0.003518,-0.002276,-0.002919,0.004805,-0.003563,0.000299,-0.004851,-0.000344,0.001587,-0.000988,0.002231,0.001587,-0.000344,-0.002276,-0.004851,-0.000988,0.000299,-0.001632,-0.004207,0.001587,0.002231,0.001587,-0.003563,-0.004207,0.006321,0.003103,0.005517,0.000689,0.000689,-0.002530,0.003103,0.004712,0.000689,0.001493,0.003103,0.004712,0.004712,-0.002530,-0.000116,0.000689,0.002298,-0.002530,0.000689,0.000689,0.001493,0.001493,-0.000116,0.001493,0.003907,0.006321,0.004712,0.000689,-0.000921,0.003907,-0.001725,-0.000921,0.002864,-0.003234,0.000092,0.004527,-0.001571,0.002864,-0.001571,-0.003234,0.000092,0.002864,-0.003234,0.001201,0.004527,0.001755,0.000647,0.000647,0.002864,-0.001016,0.001201,0.001755,0.001201,0.000092,0.001201,0.002864,0.002864,0.002864,-0.000462,0.001201,0.003973,0.001201,0.002310,0.000647,-0.004559,-0.006812,-0.002306,-0.001179,-0.005685,-0.000053,-0.010191,-0.004559,-0.002306,-0.007938,-0.006812,-0.007938,-0.002306,-0.003432,-0.000053,0.001074,0.002200,-0.001179,-0.011318,0.001074,0.001074,-0.000053,0.001074,-0.000053,-0.000053,0.005580,-0.002306,-0.004559,0.002200,0.003327,0.002200,0.003327,-0.001126,-0.003111,0.000197,-0.000465,0.006152,0.000197,-0.001788,0.002843,-0.000465,-0.000465,0.002182,-0.002449,-0.003773,-0.000465,0.000859,0.001520,0.004167,-0.003773,0.002182,0.003505,0.000197,0.000859,0.002182,-0.002449,-0.000465,0.001520,-0.000465,-0.000465,0.003505,0.004167,0.002182,0.003505,-0.000078,0.004321,-0.001544,-0.003010,-0.003744,-0.000811,-0.000811,-0.000078,-0.003744,0.003588,0.005787,-0.000078,-0.002277,-0.005210,0.002122,-0.000078,0.003588,0.000655,-0.003744,-0.003010,-0.003010,-0.000078,-0.003744,0.001388,-0.005210,-0.001544,0.004321,-0.000078,0.000655,0.002122,0.001388,0.005787]

# Run Python reference
py_floats, d, dmin, sc, m = dequantize_q4_k(bytes(go_bytes))

print(f"Index 0: Py={py_floats[0]:.6f}, Go={go_floats[0]:.6f}")
print(f"Header: d={d:.10f}, dmin={dmin:.10f}")
print(f"Scales (sc): {sc}")
print(f"Mins (m): {m}")

# Compare
max_err = 0
for i in range(256):
    err = abs(py_floats[i] - go_floats[i])
    max_err = max(max_err, err)
    if err > 1e-5:
        print(f"Mismatch at index {i}: Py={py_floats[i]:.6f}, Go={go_floats[i]:.6f}, Err={err:.6f}")

print(f"\nFinal Max Error: {max_err:.10f}")
if max_err < 1e-5:
    print("SUCCESS: Go implementation matches Python reference.")
else:
    print("FAILURE: Implementations differ.")
